# 《MySQL 必知必会》教程分析笔记

## 第13章 临时表：复杂查询，如何保存中间结果？

### Q1：这一章的内容属于哪一类别？

数据库/MySQL。

### Q2：这一章的内容是什么？

介绍MySQL 临时表的基础知识。

### Q3：这一章的大纲是什么？

- 临时表是什么？
- 如何用临时表简化复杂查询？
- 内存临时表和磁盘临时表
- 总结

### Q4：作者想要解决什么问题？

- 怎么利用临时表把一个复杂查询变得简单而且容易实现？

### Q5：这一章的关键词是什么？

### Q6：这一章的关键句是什么？

#### 临时表是什么？

- 临时表的定义
  - 临时表是一种特殊的表，用来存储查询的中间结果，并且会随着当前连接的结束而自动删除。

- 临时表的种类
  - 内部临时表：主要用于性能优化，由系统自动产生，我们无法看到。
  - 外部临时表：通过 SQL 语句创建，我们可以使用。

- 临时表的创建语法结构

  ```sql
  CREATE TEMPORARY TABLE tbl_name
  (col_name column_definition)
  ```

- 跟普通表相比，临时表有 3 个不同的特征：
  - 临时表的创建语法需要用到关键字 TEMPORARY；
  - 临时表创建完成之后，只有当前连接可见，其他连接是看不到的，具有连接隔离性；
  - 临时表在当前连接结束之后，会被自动删除。

- 临时表的用途：存储 SQL 查询的中间结果
  - 因为临时表有连接隔离性，不同连接创建相同名称的临时表也不会产生冲突，适合并发程序的运行。
  - 而且，连接结束之后，临时表会自动删除，也不用担心大量无用的中间数据会残留在数据库中。
    因此，我们就可以利用这些特点，用临时表来存储 SQL 查询的中间结果。

#### 如何用临时表简化复杂查询？

- 通过临时表，我们就可以把一个复杂的问题拆分成很多个前后关联的步骤，把中间的运行结果存储起来，用于之后的查询。
  这样一来，就把面向集合的 SQL 查询变成了面向过程的编程模式，大大降低了难度。

#### 内存临时表和磁盘临时表

- 临时表的种类
  - 由于采用的存储方式不同，临时表也可分为内存临时表和磁盘临时表。
  - 在磁盘上创建临时表时，只要我们不指定存储引擎，MySQL 会默认存储引擎是 InnoDB，并且把表存放在磁盘上。
  - 可以通过指定引擎类型（比如`ENGINE=MEMORY`），来告诉 MySQL 临时表存储在内存中。

  ```sql
  mysql> CREATE TEMPORARY TABLE demo.mytrans
  -> (
  -> itemnumber int,
  -> groupnumber int,
  -> branchnumber int
  -> ) ENGINE = MEMORY; （临时表数据存在内存中）
  Query OK, 0 rows affected (0.00 sec)
  ```

- 临时表的对比

  | 类别 | 优点 | 缺点 |
  | ---- | ---- | ---- |
  | 内存临时表 | 查询速度快 | 一旦断电，全部丢失，数据无法找回 |
  | 磁盘临时表 | 数据不易丢失 | 速度相对较慢 |

#### 总结

- 临时表的好处
  - 可以帮助我们把复杂的 SQL 查询拆分成多个简单的 SQL 查询，
  - 因为临时表是连接隔离的，不同的连接可以使用相同的临时表名称，相互之间不会受到影响。
  - 临时表会在连接结束的时候自动删除，不会占用磁盘空间。

- 临时表的不足
  - 挤占空间

- 建议：在使用临时表的时候，要从简化查询和挤占资源两个方面综合考虑，
  既不能过度加重系统的负担，同时又能够通过存储中间结果，最大限度地简化查询。
